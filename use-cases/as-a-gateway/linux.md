# Linux

On Linux, you can pre create the tun device and persistent the route/iptables to the interface.

## Create Tunnel

```bash
sudo ip tuntap add mode tun user alice name utun
sudo ip link set dev utun1989 up
```

## Routing Traffic

{% tabs %}
{% tab title="With FakeIP" %}
```bash
sudo ip route add 198.18.0.0/16 dev utun1989
```
{% endtab %}

{% tab title="Without FakeIP" %}
It involves in two parts:

* Routing traffic through proxy
* Traffics initialised from local machine

The 2nd one is a bit tricky - the whole idea is to route all traffic to the tun, except for the traffic that was initialised by the software itself.

To archive this, we can leverage on the iptables -m owner module and run the software under a known uid and bypass the traffic generated by the uid.

### Setup iptables

{% code fullWidth="false" %}
```bash
iptables -t mangle -N CLASH # Create Clash Chain

iptables -t mangle -A CLASH -d 0.0.0.0/8 -j RETURN
iptables -t mangle -A CLASH -d 10.0.0.0/8 -j RETURN
iptables -t mangle -A CLASH -d 127.0.0.0/8 -j RETURN
iptables -t mangle -A CLASH -d 169.254.0.0/16 -j RETURN
iptables -t mangle -A CLASH -d 172.16.0.0/12 -j RETURN
iptables -t mangle -A CLASH -d 192.168.0.0/16 -j RETURN
iptables -t mangle -A CLASH -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A CLASH -d 240.0.0.0/4 -j RETURN
# ipset can be enabled optionally.
# iptables -t mangle -A CLASH -m set --match-set CN dst -j RETURN
iptables -t mangle -A CLASH -j MARK --set-xmark 129

iptables -t mangle -A PREROUTING -j CLASH  # have traffic come to the CLASH chain

# if you need to have the local machine(the machine clash is running on) traffic to go through clash TUN
# note: you should have clash running under the user `clash', see below systemd script
# iptables -t mangle -A OUTPUT -m owner --uid-owner clash -j RETURN
# iptables -t mangle -A OUTPUT -j CLASH
```
{% endcode %}

## Setup routing

```bash
ip route add default dev $TUN_NAME table 129
ip rule add fwmark 129 $TUN_NAME lookup 129
```

{% hint style="info" %}
**How the whole thing works**

1. First, we created a new iptables chain CLASH, which will put a mark on all the traffic going through it, wich certain destinations exclude (those RETURNs)
2. For routing traffic, we tell the PREROUTING chain to mark all the traffic that we are interested in.
3. For traffic from local machine, we do the same, with OUTPUT chain, and bypass the traffic generated from certain uid
4. Finally, we route all traffic marked with certain number to go through our tunnel, hence handled by ClashRS tunnel


{% endhint %}
{% endtab %}
{% endtabs %}

## Persistence

```sh
$ cat /etc/network/interfaces | grep -A 20 clash0
auto utun1989
iface utun1989 inet manual
      pre-up ip tuntap add mode tun user clash name $IFACE
      up ip link set dev $IFACE up
      post-up ip route add default dev $IFACE table 192
      post-up ip rule add fwmark 192 lookup 192
      down ip link set dev $IFACE down
      post-down ip link del dev $IFACE
      post-down ip route del default dev $IFACE table 192
      post-down ip rule del fwmark 192 lookup 192
```
